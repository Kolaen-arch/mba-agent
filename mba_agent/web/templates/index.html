<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MBA Paper Agent</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@400;500;600&family=Lora:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* ═══════════════════════════════════════════════════════
   DESIGN TOKENS — Academic Library
   ═══════════════════════════════════════════════════════ */
:root {
  /* Background layers */
  --bg:               #FAF8F4;
  --bg-sidebar:       #F3EDE4;
  --bg-sidebar-hover: #EAE3D8;
  --bg-sidebar-active:#E2DACF;
  --bg-card:          #FFFFFF;
  --bg-paper:         #FDFCFA;
  --bg-user:          #F0EBE2;
  --bg-code:          #F5F0E8;
  --bg-dark:          #2D2A26;

  /* Borders */
  --border:           #DDD6CB;
  --border-light:     #EAE3D8;
  --border-focus:     #B5A08A;

  /* Text */
  --text:             #2D2A26;
  --text-secondary:   #6B6560;
  --text-muted:       #9A948C;
  --text-inverse:     #FDFCFA;

  /* Accent — warm bronze */
  --accent:           #8B6E4E;
  --accent-hover:     #7A5F42;
  --accent-soft:      #D4C4AE;

  /* Status */
  --green:            #5A8C6F;
  --red:              #B85C5C;
  --blue:             #5A7EB8;

  /* Fonts */
  --font-ui:    'Inter', -apple-system, system-ui, sans-serif;
  --font-serif: 'Lora', Georgia, 'Times New Roman', serif;
  --font-mono:  'IBM Plex Mono', monospace;

  /* Layout */
  --sidebar-w:   260px;
  --doc-panel-w: 380px;
  --chat-max-w:  720px;

  /* Radius */
  --r-sm:   6px;
  --r-md:   10px;
  --r-lg:   16px;
  --r-pill: 24px;

  /* Motion */
  --ease: 150ms ease;
}


/* ═══════════════════════════════════════════════════════
   RESET & BASE
   ═══════════════════════════════════════════════════════ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font-ui);
  background: var(--bg);
  color: var(--text);
  height: 100vh;
  overflow: hidden;
  display: flex;
  font-size: 14px;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

::selection { background: var(--accent-soft); }


/* ═══════════════════════════════════════════════════════
   SCROLLBARS
   ═══════════════════════════════════════════════════════ */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }


/* ═══════════════════════════════════════════════════════
   SIDEBAR
   ═══════════════════════════════════════════════════════ */
.sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  background: var(--bg-sidebar);
  display: flex;
  flex-direction: column;
  height: 100vh;
  border-right: 1px solid var(--border-light);
}

.sidebar-top { padding: 16px 16px 12px; }

.sidebar-brand {
  font-family: var(--font-serif);
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 12px;
  padding: 0 2px;
  letter-spacing: -0.01em;
}

.new-chat-btn {
  width: 100%;
  padding: 9px 14px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  color: var(--text);
  font-family: var(--font-ui);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--ease);
  text-align: left;
  display: flex;
  align-items: center;
  gap: 8px;
}
.new-chat-btn:hover {
  border-color: var(--border-focus);
  box-shadow: 0 1px 3px rgba(0,0,0,.06);
}

/* Progress card */
.progress-card {
  margin: 8px 16px 4px;
  padding: 12px;
  background: var(--bg-card);
  border-radius: var(--r-sm);
  border: 1px solid var(--border-light);
}
.progress-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
}
.progress-track {
  height: 6px;
  background: var(--border-light);
  border-radius: 3px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: var(--green);
  border-radius: 3px;
  transition: width .3s;
}
.progress-stats {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 10px;
  font-family: var(--font-mono);
  color: var(--text-muted);
}

/* Import button */
.import-btn {
  width: calc(100% - 32px);
  margin: 8px 16px 0;
  padding: 7px 10px;
  background: transparent;
  border: 1px dashed var(--border);
  border-radius: var(--r-sm);
  color: var(--text-muted);
  font-family: var(--font-ui);
  font-size: 11px;
  cursor: pointer;
  transition: var(--ease);
}
.import-btn:hover {
  border-color: var(--border-focus);
  color: var(--text-secondary);
}

/* Session list */
.session-list { flex: 1; overflow-y: auto; padding: 8px 10px; }

.date-group {
  padding: 10px 8px 4px;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: .5px;
}
.session-item {
  padding: 8px 10px;
  border-radius: var(--r-sm);
  cursor: pointer;
  transition: var(--ease);
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1px;
}
.session-item:hover { background: var(--bg-sidebar-hover); }
.session-item.active { background: var(--bg-sidebar-active); }
.session-item .session-title {
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
  min-width: 0;
}
.session-item .session-actions { opacity: 0; transition: opacity .1s; }
.session-item:hover .session-actions { opacity: 1; }
.session-item .delete-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 4px;
  font-size: 12px;
}
.session-item .delete-btn:hover { color: var(--red); }

/* Sidebar footer */
.sidebar-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border-light);
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.stat-row {
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--text-muted);
  display: flex;
  justify-content: space-between;
}


/* ═══════════════════════════════════════════════════════
   MAIN LAYOUT
   ═══════════════════════════════════════════════════════ */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  height: 100vh;
  min-width: 0;
}


/* ═══════════════════════════════════════════════════════
   TOOLBAR
   ═══════════════════════════════════════════════════════ */
.toolbar {
  padding: 8px 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  min-height: 44px;
  border-bottom: 1px solid var(--border-light);
  flex-wrap: wrap;
}
.mode-pills {
  display: flex;
  gap: 2px;
  background: var(--bg-sidebar);
  border-radius: var(--r-pill);
  padding: 3px;
}
.mode-pill {
  padding: 5px 12px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-family: var(--font-ui);
  font-size: 11.5px;
  font-weight: 500;
  cursor: pointer;
  border-radius: var(--r-pill);
  transition: var(--ease);
  white-space: nowrap;
}
.mode-pill:hover { color: var(--text); }
.mode-pill.active {
  background: var(--bg-card);
  color: var(--text);
  box-shadow: 0 1px 2px rgba(0,0,0,.06);
}

.toolbar-spacer { flex: 1; }

.section-select {
  padding: 5px 8px;
  background: var(--bg-sidebar);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--text-secondary);
  max-width: 200px;
}
.docs-toggle {
  padding: 5px 12px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  color: var(--text-secondary);
  font-size: 12px;
  font-family: var(--font-ui);
  cursor: pointer;
  transition: var(--ease);
}
.docs-toggle:hover { border-color: var(--border-focus); color: var(--text); }
.docs-toggle.has-docs { border-color: var(--accent-soft); color: var(--accent); }

.model-label {
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--text-muted);
}


/* ═══════════════════════════════════════════════════════
   CHAT AREA
   ═══════════════════════════════════════════════════════ */
.chat-area {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.chat-scroll {
  width: 100%;
  max-width: var(--chat-max-w);
  padding: 24px 20px 100px;
  flex: 1;
}


/* ═══════════════════════════════════════════════════════
   EMPTY STATE
   ═══════════════════════════════════════════════════════ */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 60vh;
  text-align: center;
  padding: 40px 20px;
}
.empty-ornament {
  width: 48px;
  height: 2px;
  background: var(--accent-soft);
  margin-bottom: 24px;
  border-radius: 1px;
}
.empty-state h2 {
  font-family: var(--font-serif);
  font-size: 24px;
  font-weight: 500;
  margin-bottom: 8px;
  letter-spacing: -0.01em;
}
.empty-state p {
  color: var(--text-secondary);
  font-size: 14px;
  max-width: 460px;
  margin-bottom: 28px;
  line-height: 1.7;
}
.quick-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  max-width: 580px;
}
.quick-action {
  padding: 8px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-pill);
  color: var(--text-secondary);
  font-size: 12px;
  font-family: var(--font-ui);
  cursor: pointer;
  transition: var(--ease);
}
.quick-action:hover {
  border-color: var(--accent-soft);
  color: var(--text);
}


/* ═══════════════════════════════════════════════════════
   MESSAGES
   ═══════════════════════════════════════════════════════ */
.message {
  margin-bottom: 28px;
  animation: msg-in .2s ease;
}
@keyframes msg-in {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}

.msg-label {
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.msg-label.is-user { color: var(--text-secondary); }
.msg-label.is-agent { color: var(--accent); }

.mode-tag {
  font-size: 10px;
  font-weight: 500;
  padding: 1px 7px;
  border-radius: 4px;
  background: var(--bg-sidebar);
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: .3px;
}
.model-badge {
  font-size: 10px;
  font-family: var(--font-mono);
  padding: 1px 6px;
  border-radius: 3px;
  background: var(--bg-code);
  color: var(--text-muted);
}

.msg-content { line-height: 1.7; }

.msg-content.user-content {
  background: var(--bg-user);
  padding: 12px 16px;
  border-radius: var(--r-md);
  font-size: 14px;
  white-space: pre-wrap;
}

.msg-content.agent-content {
  font-family: var(--font-serif);
  font-size: 15px;
  padding: 4px 0;
}

/* Agent content — typography */
.msg-content.agent-content h1 { font-family: var(--font-ui); font-size: 20px; font-weight: 600; margin: 24px 0 8px; }
.msg-content.agent-content h2 { font-family: var(--font-ui); font-size: 17px; font-weight: 600; margin: 20px 0 6px; }
.msg-content.agent-content h3 { font-family: var(--font-ui); font-size: 15px; font-weight: 600; margin: 16px 0 4px; }
.msg-content.agent-content h4 { font-family: var(--font-ui); font-size: 14px; font-weight: 600; margin: 14px 0 4px; }
.msg-content.agent-content p  { margin-bottom: 10px; }
.msg-content.agent-content ul,
.msg-content.agent-content ol { margin: 8px 0 12px; padding-left: 24px; }
.msg-content.agent-content li { margin-bottom: 4px; }
.msg-content.agent-content strong { font-weight: 600; }

.msg-content.agent-content blockquote {
  border-left: 3px solid var(--accent-soft);
  padding: 8px 16px;
  margin: 12px 0;
  color: var(--text-secondary);
  font-style: italic;
  background: rgba(0,0,0,.015);
  border-radius: 0 var(--r-sm) var(--r-sm) 0;
}

.msg-content.agent-content code {
  font-family: var(--font-mono);
  font-size: 12px;
  background: var(--bg-code);
  padding: 2px 6px;
  border-radius: 4px;
}
.msg-content.agent-content pre {
  background: var(--bg-code);
  border: 1px solid var(--border-light);
  border-radius: var(--r-sm);
  padding: 14px;
  overflow-x: auto;
  margin: 12px 0;
  font-size: 12px;
}
.msg-content.agent-content pre code { background: none; padding: 0; }

.msg-content.agent-content table {
  border-collapse: collapse;
  width: 100%;
  margin: 12px 0;
  font-family: var(--font-ui);
  font-size: 13px;
}
.msg-content.agent-content th,
.msg-content.agent-content td { padding: 8px 12px; border: 1px solid var(--border-light); }
.msg-content.agent-content th { background: var(--bg-sidebar); font-weight: 600; }

/* Message footer — sources + actions */
.msg-footer {
  margin-top: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}
.source-chip {
  display: inline-flex;
  padding: 2px 10px;
  background: var(--bg-sidebar);
  border-radius: var(--r-pill);
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--text-muted);
}
.action-btn {
  padding: 4px 10px;
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--r-pill);
  font-size: 11px;
  font-family: var(--font-ui);
  color: var(--text-muted);
  cursor: pointer;
  transition: var(--ease);
}
.action-btn:hover { color: var(--accent); border-color: var(--accent-soft); }


/* ═══════════════════════════════════════════════════════
   THINKING INDICATOR
   ═══════════════════════════════════════════════════════ */
.thinking-box {
  margin: 8px 0;
  background: var(--bg-code);
  border-left: 3px solid var(--accent-soft);
  border-radius: 0 var(--r-sm) var(--r-sm) 0;
  font-size: 12px;
  font-family: var(--font-mono);
  color: var(--text-muted);
  display: none;
  overflow: hidden;
}
.thinking-box.is-visible { display: block; }

.thinking-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 8px 12px;
  background: none;
  border: none;
  cursor: pointer;
  font-family: var(--font-mono);
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .5px;
  color: var(--accent-soft);
}
.thinking-toggle:hover { color: var(--accent); }
.thinking-chevron {
  transition: transform .15s;
  font-size: 12px;
}
.thinking-box.collapsed .thinking-chevron { transform: rotate(-90deg); }
.thinking-box.collapsed .thinking-content { display: none; }
.thinking-content {
  padding: 0 12px 10px;
  max-height: 150px;
  overflow-y: auto;
  white-space: pre-wrap;
  line-height: 1.5;
}


/* ═══════════════════════════════════════════════════════
   LOADING INDICATOR
   ═══════════════════════════════════════════════════════ */
.loading-bar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 0;
  color: var(--text-muted);
  font-size: 13px;
}
.loading-dots { display: flex; gap: 4px; }
.loading-dots span {
  width: 6px;
  height: 6px;
  background: var(--accent-soft);
  border-radius: 50%;
  animation: dot-pulse 1.2s infinite;
}
.loading-dots span:nth-child(2) { animation-delay: .15s; }
.loading-dots span:nth-child(3) { animation-delay: .3s; }
@keyframes dot-pulse {
  0%, 80%, 100% { opacity: .3; transform: scale(.85); }
  40%           { opacity: 1;  transform: scale(1); }
}


/* ═══════════════════════════════════════════════════════
   INPUT AREA
   ═══════════════════════════════════════════════════════ */
.input-area {
  padding: 0 20px 16px;
  display: flex;
  justify-content: center;
}
.input-container {
  width: 100%;
  max-width: var(--chat-max-w);
}
.input-box {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-md);
  padding: 10px 14px 10px 18px;
  transition: border-color var(--ease), box-shadow var(--ease);
  box-shadow: 0 1px 4px rgba(0,0,0,.04);
}
.input-box:focus-within {
  border-color: var(--border-focus);
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
}
.input-box textarea {
  flex: 1;
  border: none;
  background: transparent;
  color: var(--text);
  font-family: var(--font-ui);
  font-size: 14px;
  line-height: 1.5;
  resize: none;
  min-height: 24px;
  max-height: 180px;
  outline: none;
  padding: 4px 0;
}
.input-box textarea::placeholder { color: var(--text-muted); }

.send-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: var(--text);
  color: var(--text-inverse);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--ease);
  flex-shrink: 0;
}
.send-btn:hover { background: var(--accent); }
.send-btn:disabled { opacity: .3; cursor: not-allowed; }
.send-btn svg { width: 16px; height: 16px; }

.abort-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: var(--red);
  color: var(--text-inverse);
  cursor: pointer;
  display: none;
  align-items: center;
  justify-content: center;
  transition: var(--ease);
  flex-shrink: 0;
}
.abort-btn:hover { opacity: .85; }
.abort-btn svg { width: 14px; height: 14px; }

.input-meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  padding: 0 4px;
}
.input-hint { font-size: 11px; color: var(--text-muted); }

/* Override controls */
.overrides { display: flex; gap: 12px; align-items: center; }
.override-group { display: flex; align-items: center; gap: 3px; }
.override-label {
  font-size: 10px;
  font-family: var(--font-mono);
  color: var(--text-muted);
  letter-spacing: .3px;
  margin-right: 2px;
}
.override-pill {
  padding: 2px 8px;
  border: 1px solid var(--border-light);
  background: transparent;
  border-radius: var(--r-pill);
  font-size: 10px;
  font-family: var(--font-mono);
  color: var(--text-muted);
  cursor: pointer;
  transition: var(--ease);
  line-height: 1.4;
}
.override-pill:hover { border-color: var(--border); color: var(--text-secondary); }
.override-pill.active {
  background: var(--bg-card);
  border-color: var(--border-focus);
  color: var(--text);
  font-weight: 500;
}
.override-pill.active-opus { border-color: var(--accent); color: var(--accent); }
.override-pill.active-sonnet { border-color: var(--blue); color: var(--blue); }


/* ═══════════════════════════════════════════════════════
   DOCUMENT PANEL
   ═══════════════════════════════════════════════════════ */
.doc-panel {
  width: 0;
  overflow: hidden;
  background: var(--bg-paper);
  border-left: 1px solid var(--border-light);
  transition: width .25s ease;
  display: flex;
  flex-direction: column;
}
.doc-panel.is-open {
  width: var(--doc-panel-w);
  min-width: var(--doc-panel-w);
}
.doc-panel-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border-light);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.doc-panel-header h3 {
  font-size: 13px;
  font-weight: 600;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.close-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  padding: 0 4px;
  line-height: 1;
}
.close-btn:hover { color: var(--text); }

.doc-file-list {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border-light);
  max-height: 160px;
  overflow-y: auto;
}
.doc-file-item {
  padding: 7px 10px;
  border-radius: var(--r-sm);
  cursor: pointer;
  font-size: 12px;
  display: flex;
  justify-content: space-between;
  transition: var(--ease);
}
.doc-file-item:hover { background: var(--bg-sidebar-hover); }
.doc-file-item.active { background: var(--bg-sidebar-active); font-weight: 500; }
.doc-file-item .file-info {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-muted);
}

.doc-body {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  font-family: var(--font-serif);
  font-size: 13px;
  line-height: 1.7;
  color: var(--text-secondary);
}

.doc-actions {
  padding: 10px 12px;
  border-top: 1px solid var(--border-light);
  display: flex;
  gap: 6px;
}
.doc-action-btn {
  flex: 1;
  padding: 7px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  color: var(--text-secondary);
  font-size: 12px;
  font-family: var(--font-ui);
  cursor: pointer;
  transition: var(--ease);
  text-align: center;
}
.doc-action-btn:hover { border-color: var(--border-focus); color: var(--text); }


/* ═══════════════════════════════════════════════════════
   TOAST
   ═══════════════════════════════════════════════════════ */
.toast-container {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
}
.toast {
  padding: 8px 18px;
  background: var(--bg-dark);
  color: var(--text-inverse);
  border-radius: var(--r-pill);
  font-size: 13px;
  opacity: 0;
  transform: translateY(8px);
  transition: all .2s ease;
  white-space: nowrap;
}
.toast.is-visible { opacity: 1; transform: translateY(0); }


/* ═══════════════════════════════════════════════════════
   SELECTION MENU (doc panel)
   ═══════════════════════════════════════════════════════ */
.sel-menu {
  position: absolute;
  display: none;
  background: var(--bg-dark);
  border-radius: var(--r-pill);
  padding: 4px;
  gap: 2px;
  z-index: 100;
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
  white-space: nowrap;
}
.sel-menu.is-visible { display: flex; }
.sel-menu-btn {
  padding: 5px 12px;
  background: transparent;
  border: none;
  color: var(--text-inverse);
  font-family: var(--font-ui);
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  border-radius: var(--r-pill);
  transition: background .1s;
}
.sel-menu-btn:hover { background: rgba(255,255,255,.15); }


/* ═══════════════════════════════════════════════════════
   MODAL
   ═══════════════════════════════════════════════════════ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 200;
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-overlay.is-visible { display: flex; }
.modal-box {
  background: var(--bg-card);
  border-radius: var(--r-lg);
  padding: 28px;
  width: 420px;
  max-width: 90vw;
  box-shadow: 0 8px 32px rgba(0,0,0,.15);
}
.modal-box h3 {
  font-family: var(--font-serif);
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
}
.modal-field { margin-bottom: 14px; }
.modal-field label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  margin-bottom: 4px;
}
.modal-field input,
.modal-field select {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  font-family: var(--font-ui);
  font-size: 13px;
  background: var(--bg);
}
.modal-field input:focus,
.modal-field select:focus { outline: none; border-color: var(--border-focus); }
.modal-lang-row { display: flex; gap: 12px; }
.modal-lang-row label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 13px;
  cursor: pointer;
  font-weight: 400;
  color: var(--text);
}
.modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }
.modal-btn {
  padding: 8px 18px;
  border-radius: var(--r-sm);
  font-family: var(--font-ui);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--bg-card);
  color: var(--text);
  transition: var(--ease);
}
.modal-btn:hover { border-color: var(--border-focus); }
.modal-btn.primary {
  background: var(--text);
  color: var(--text-inverse);
  border-color: var(--text);
}
.modal-btn.primary:hover { background: var(--accent); border-color: var(--accent); }
</style>
</head>
<body>

<!-- ═══ Sidebar ═══ -->
<aside class="sidebar">
  <div class="sidebar-top">
    <div class="sidebar-brand">Paper Agent</div>
    <button class="new-chat-btn" onclick="newSession()">
      <span style="opacity:.5;font-size:16px">+</span> New chat
    </button>
  </div>

  <div class="progress-card" id="progBox" style="display:none">
    <div class="progress-label"><span>Paper Progress</span><span id="progPct">0%</span></div>
    <div class="progress-track"><div class="progress-fill" id="progFill" style="width:0%"></div></div>
    <div class="progress-stats"><span id="progWords">0 words</span><span id="progPages">0 pages</span></div>
  </div>

  <button class="import-btn" onclick="importBib()">Import BibTeX / Zotero</button>
  <button class="import-btn" onclick="showScaffold()">New Paper Structure</button>
  <div class="session-list" id="sList"></div>

  <div class="sidebar-footer">
    <div class="stat-row"><span>Sources</span><span id="sS">&mdash;</span></div>
    <div class="stat-row"><span>Chunks</span><span id="sC">&mdash;</span></div>
    <div class="stat-row"><span>Citations</span><span id="sCi">&mdash;</span></div>
    <div class="stat-row"><span>Verified</span><span id="sCv">&mdash;</span></div>
    <div class="stat-row"><span>Session cost</span><span id="sCost">&mdash;</span></div>
  </div>
</aside>

<!-- ═══ Main ═══ -->
<main class="main">
  <div class="toolbar">
    <div class="mode-pills">
      <button class="mode-pill active" data-m="chat" onclick="setMode('chat')">Chat</button>
      <button class="mode-pill" data-m="draft" onclick="setMode('draft')">Draft</button>
      <button class="mode-pill" data-m="review" onclick="setMode('review')">Review</button>
      <button class="mode-pill" data-m="synthesize" onclick="setMode('synthesize')">Synth</button>
    </div>
    <div class="toolbar-spacer"></div>
    <select class="section-select" id="secSel" onchange="S.secId=this.value" title="Working section">
      <option value="">&mdash; section &mdash;</option>
    </select>
    <button class="docs-toggle" id="dTog" onclick="togDoc()">Docs</button>
    <span class="model-label" id="mLab"></span>
  </div>

  <div class="chat-area" id="cArea">
    <div class="chat-scroll" id="cScroll">
      <div class="empty-state" id="empty">
        <div class="empty-ornament"></div>
        <h2>What are you working on?</h2>
        <p>Responses stream in real-time. Heavy tasks (Draft, Synth, Review) use Opus with extended thinking. Chat and Cite use Sonnet for speed.</p>
        <div class="quick-actions">
          <button class="quick-action" onclick="qs('chat','Discuss my theoretical framework')">Discuss framework</button>
          <button class="quick-action" onclick="qs('draft','Draft section on...')">Draft a section</button>
          <button class="quick-action" onclick="qs('review','Review this passage...')">Review passage</button>
          <button class="quick-action" onclick="qs('synthesize','Synthesize literature on...')">Synthesize literature</button>
        </div>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-container">
      <div class="input-box">
        <textarea id="inp" rows="1" placeholder="Ask something about your paper..." onkeydown="hk(event)" oninput="ag(this)"></textarea>
        <button class="send-btn" id="sBtn" onclick="send()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
        <button class="abort-btn" id="aBtn" onclick="abortStream()" title="Cancel (Esc)">
          <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
        </button>
      </div>
      <div class="input-meta">
        <span class="input-hint" id="iH">Chat &middot; Shift+Enter for newline</span>
        <div class="overrides">
          <div class="override-group">
            <span class="override-label">Model</span>
            <button class="override-pill active" data-ov="model" data-v="" onclick="setOv('model',this)">Auto</button>
            <button class="override-pill" data-ov="model" data-v="claude-opus-4-6" onclick="setOv('model',this)">Opus</button>
            <button class="override-pill" data-ov="model" data-v="claude-sonnet-4-5-20250929" onclick="setOv('model',this)">Sonnet</button>
          </div>
          <div class="override-group">
            <span class="override-label">Think</span>
            <button class="override-pill active" data-ov="think" data-v="" onclick="setOv('think',this)">Auto</button>
            <button class="override-pill" data-ov="think" data-v="10000" onclick="setOv('think',this)">On</button>
            <button class="override-pill" data-ov="think" data-v="0" onclick="setOv('think',this)">Off</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- ═══ Document Panel ═══ -->
<aside class="doc-panel" id="dPan">
  <div class="doc-panel-header">
    <h3 id="dTit">Documents</h3>
    <button class="close-btn" onclick="togDoc()">&times;</button>
  </div>
  <div class="doc-file-list" id="dFL"></div>
  <div class="doc-body" id="dBd" style="position:relative">
    <p style="color:var(--text-muted);text-align:center;margin-top:40px">Select a document above</p>
    <div class="sel-menu" id="selMenu">
      <button class="sel-menu-btn" onclick="selAction('review')">Review</button>
      <button class="sel-menu-btn" onclick="selAction('draft')">Improve</button>
      <button class="sel-menu-btn" onclick="selAction('cite')">Find Citation</button>
    </div>
  </div>
  <div class="doc-actions">
    <button class="doc-action-btn" onclick="sendForReview()">Review</button>
    <button class="doc-action-btn" onclick="syncDoc()">Sync</button>
    <button class="doc-action-btn" onclick="runAutoSync()">Auto-sync</button>
    <button class="doc-action-btn" onclick="redThreadAudit()">Red Thread</button>
  </div>
</aside>

<!-- ═══ Scaffold Modal ═══ -->
<div class="modal-overlay" id="scaffoldModal">
  <div class="modal-box">
    <h3>New Paper Structure</h3>
    <div class="modal-field">
      <label>Paper Title</label>
      <input type="text" id="scTitle" placeholder="MBA Final Paper">
    </div>
    <div class="modal-field">
      <label>Research Question</label>
      <input type="text" id="scRQ" placeholder="How does X affect Y in the context of Z?">
    </div>
    <div class="modal-field">
      <label>Methodology</label>
      <select id="scMeth">
        <option value="Design Science Research">Design Science Research</option>
        <option value="Case Study">Case Study</option>
        <option value="Survey">Survey</option>
        <option value="Mixed Methods">Mixed Methods</option>
        <option value="Generic">Generic</option>
      </select>
    </div>
    <div class="modal-field">
      <label>Language</label>
      <div class="modal-lang-row">
        <label><input type="radio" name="scLang" value="en" checked> English</label>
        <label><input type="radio" name="scLang" value="da"> Dansk</label>
      </div>
    </div>
    <div class="modal-actions">
      <button class="modal-btn" onclick="hideScaffold()">Cancel</button>
      <button class="modal-btn primary" onclick="createScaffold()">Create</button>
    </div>
  </div>
</div>

<div class="toast-container"><div class="toast" id="toast"></div></div>

<script>
/* ═══════════════════════════════════════════════════════
   STATE
   ═══════════════════════════════════════════════════════ */
let S = {
  ses: null, mode: 'chat', loading: false, dpOpen: false,
  dPath: '', dData: null, lastResp: '', sessions: [],
  secId: '', structure: null, streamEl: null, streamText: '',
  modelInfo: null, ovModel: '', ovThink: '', abortCtrl: null
};


/* ═══════════════════════════════════════════════════════
   OVERRIDE CONTROLS
   ═══════════════════════════════════════════════════════ */
function setOv(group, btn) {
  const v = btn.dataset.v;
  if (group === 'model') S.ovModel = v;
  else S.ovThink = v;
  document.querySelectorAll(`.override-pill[data-ov="${group}"]`).forEach(b => {
    b.classList.remove('active', 'active-opus', 'active-sonnet');
  });
  btn.classList.add('active');
  if (group === 'model' && v.includes('opus')) btn.classList.add('active-opus');
  if (group === 'model' && v.includes('sonnet')) btn.classList.add('active-sonnet');
}


/* ═══════════════════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', async () => {
  await Promise.all([loadSt(), loadSes(), loadDL(), loadStruct()]);
  document.getElementById('inp').focus();
});

async function api(u, o = {}) {
  return (await fetch(u, { headers: { 'Content-Type': 'application/json' }, ...o })).json();
}


/* ═══════════════════════════════════════════════════════
   STATUS & STRUCTURE
   ═══════════════════════════════════════════════════════ */
async function loadSt() {
  try {
    const s = await api('/api/status');
    document.getElementById('sS').textContent = s.source_count;
    document.getElementById('sC').textContent = s.chunk_count.toLocaleString();
    document.getElementById('sCi').textContent = s.citation_stats?.total || s.citation_count;
    document.getElementById('sCv').textContent = s.citation_stats?.verified_from_bibtex || 0;
    S.modelInfo = s.model_routing;
  } catch (e) {}
}

async function loadStruct() {
  try {
    const d = await api('/api/structure');
    S.structure = d;
    const p = d.progress;
    if (p.total_sections > 0) {
      document.getElementById('progBox').style.display = 'block';
      document.getElementById('progPct').textContent = p.weighted_pct + '%';
      document.getElementById('progFill').style.width = p.weighted_pct + '%';
      document.getElementById('progWords').textContent = p.total_words.toLocaleString() + ' words';
      document.getElementById('progPages').textContent = '~' + p.page_estimate + ' pages';
    }
    const sel = document.getElementById('secSel');
    sel.innerHTML = '<option value="">&mdash; section &mdash;</option>';
    d.sections.forEach(s => {
      const indent = s.parent_id ? '\u00a0\u00a0' : '';
      sel.innerHTML += `<option value="${s.id}">${indent}${s.id} ${s.title}</option>`;
    });
  } catch (e) {}
}


/* ═══════════════════════════════════════════════════════
   SESSIONS
   ═══════════════════════════════════════════════════════ */
async function loadSes() { S.sessions = await api('/api/sessions'); renderSL(); }

function renderSL() {
  const el = document.getElementById('sList');
  const g = grp(S.sessions);
  let h = '';
  for (const [l, items] of g) {
    h += `<div class="date-group">${esc(l)}</div>`;
    for (const s of items) {
      h += `<div class="session-item ${S.ses?.id === s.id ? 'active' : ''}" onclick="loadS('${s.id}')">
        <span class="session-title">${esc(s.title)}</span>
        <span class="session-actions">
          <button class="delete-btn" onclick="event.stopPropagation();delS('${s.id}')">&#10005;</button>
        </span>
      </div>`;
    }
  }
  el.innerHTML = h || '<div style="padding:12px;color:var(--text-muted);font-size:13px;text-align:center">No conversations yet</div>';
}

function grp(ss) {
  const now = new Date();
  const td = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const yd = new Date(td); yd.setDate(yd.getDate() - 1);
  const wk = new Date(td); wk.setDate(wk.getDate() - 7);
  const m = new Map();
  for (const s of ss) {
    const d = new Date(s.updated_at);
    let l;
    if (d >= td) l = 'Today';
    else if (d >= yd) l = 'Yesterday';
    else if (d >= wk) l = 'Previous 7 days';
    else l = d.toLocaleDateString('en', { month: 'long', year: 'numeric' });
    if (!m.has(l)) m.set(l, []);
    m.get(l).push(s);
  }
  return m;
}

async function newSession() {
  S.ses = null;
  S.lastResp = '';
  document.getElementById('cScroll').innerHTML = `
    <div class="empty-state" id="empty">
      <div class="empty-ornament"></div>
      <h2>What are you working on?</h2>
      <p>Responses stream in real-time. Heavy tasks use Opus + extended thinking.</p>
      <div class="quick-actions">
        <button class="quick-action" onclick="qs('chat','Discuss my theoretical framework')">Discuss framework</button>
        <button class="quick-action" onclick="qs('draft','Draft section on...')">Draft a section</button>
        <button class="quick-action" onclick="qs('review','Review this passage...')">Review passage</button>
        <button class="quick-action" onclick="qs('synthesize','Synthesize literature on...')">Synthesize literature</button>
      </div>
    </div>`;
  renderSL();
  document.getElementById('inp').focus();
}

async function loadS(sid) {
  const d = await api(`/api/sessions/${sid}`);
  if (d.error) return;
  S.ses = d.session;
  setMode(d.session.mode, false);
  const sc = document.getElementById('cScroll');
  sc.innerHTML = '';
  d.messages.forEach(m => addMsg(m.role, m.content, m.context_sources, false));
  sb();
  renderSL();
  document.getElementById('inp').focus();
  // Load session cost
  try {
    const cost = await api(`/api/sessions/${sid}/cost`);
    if (cost.total_usd > 0) document.getElementById('sCost').textContent = '$' + cost.total_usd.toFixed(4);
    else document.getElementById('sCost').textContent = '$0';
  } catch (e) {}
}

async function delS(sid) {
  if (!confirm('Delete?')) return;
  await api(`/api/sessions/${sid}`, { method: 'DELETE' });
  if (S.ses?.id === sid) newSession();
  loadSes();
}


/* ═══════════════════════════════════════════════════════
   MODE SWITCHING
   ═══════════════════════════════════════════════════════ */
function setMode(m, upd = true) {
  S.mode = m;
  document.querySelectorAll('.mode-pill').forEach(b => b.classList.toggle('active', b.dataset.m === m));

  const hints = {
    chat: 'Chat', draft: 'Draft', synthesize: 'Synthesize', review: 'Review',
    cite: 'Cite', transition: 'Transition', consistency: 'Consistency', structure: 'Structure'
  };
  const placeholders = {
    chat: 'Ask something...',
    draft: 'Describe section to draft (select section above)...',
    synthesize: 'Topic for literature synthesis...',
    review: 'Paste or describe text to review...',
    cite: 'What citation?',
    transition: 'Select a section and describe the transition to analyze',
    consistency: 'Paste section text to check...',
    structure: 'Ask about paper structure or gaps...'
  };

  if (upd) {
    document.getElementById('iH').textContent = `${hints[m] || 'Chat'} \u00b7 Shift+Enter for newline`;
    document.getElementById('inp').placeholder = placeholders[m] || placeholders.chat;

    const model = S.modelInfo?.[m] || '';
    if (model) {
      document.getElementById('mLab').textContent = model
        .replace('claude-', '').replace('-20250929', '').replace('-4-6', '');
    }

    // Reset overrides to Auto
    S.ovModel = '';
    S.ovThink = '';
    document.querySelectorAll('.override-pill').forEach(b => {
      b.classList.remove('active', 'active-opus', 'active-sonnet');
    });
    document.querySelectorAll('.override-pill[data-v=""]').forEach(b => b.classList.add('active'));
  }
}


/* ═══════════════════════════════════════════════════════
   MESSAGES
   ═══════════════════════════════════════════════════════ */
function addMsg(role, content, src, anim = true, model = '') {
  const sc = document.getElementById('cScroll');
  const em = document.getElementById('empty');
  if (em) em.remove();

  const d = document.createElement('div');
  d.className = 'message';
  if (!anim) d.style.animation = 'none';
  if (role === 'assistant') S.lastResp = content;

  let ft = '';
  if (role === 'assistant') {
    const chips = src?.length
      ? src.slice(0, 6).map(s => `<span class="source-chip">${esc(s.length > 25 ? s.slice(0, 22) + '...' : s)}</span>`).join('')
      : '';
    ft = `<div class="msg-footer">${chips}<button class="action-btn" onclick="xDocx()">Export .docx</button></div>`;
  }

  const mt = role === 'assistant' && S.mode !== 'chat' ? `<span class="mode-tag">${S.mode}</span>` : '';
  const mb = role === 'assistant' && model ? `<span class="model-badge">${model.replace('claude-', '').replace('-20250929', '')}</span>` : '';

  d.innerHTML = `
    <div class="msg-label ${role === 'user' ? 'is-user' : 'is-agent'}">${role === 'user' ? 'You' : 'Agent'} ${mt}${mb}</div>
    <div class="msg-content ${role === 'user' ? 'user-content' : 'agent-content'}">${role === 'assistant' ? rmd(content) : esc(content)}</div>
    ${ft}`;
  sc.appendChild(d);
  sb();
  return d;
}


/* ═══════════════════════════════════════════════════════
   STREAMING
   ═══════════════════════════════════════════════════════ */
function startStream() {
  const sc = document.getElementById('cScroll');
  const em = document.getElementById('empty');
  if (em) em.remove();

  const d = document.createElement('div');
  d.className = 'message';
  d.id = 'streamMsg';
  d.innerHTML = `
    <div class="msg-label is-agent">Agent <span class="mode-tag" id="streamMode">${S.mode}</span> <span class="model-badge" id="streamModel"></span></div>
    <div class="thinking-box" id="thinkBox">
      <button class="thinking-toggle" onclick="toggleThinking()">
        <span>Thinking</span>
        <span class="thinking-chevron">&#9662;</span>
      </button>
      <div class="thinking-content" id="thinkText"></div>
    </div>
    <div class="msg-content agent-content" id="streamContent"></div>
    <div class="loading-bar" id="streamStatus">
      <div class="loading-dots"><span></span><span></span><span></span></div>
      <span>Connecting...</span>
    </div>`;
  sc.appendChild(d);
  S.streamText = '';
  sb();
  return d;
}

function toggleThinking() {
  const box = document.getElementById('thinkBox');
  if (box) box.classList.toggle('collapsed');
}

function appendStreamText(t) {
  S.streamText += t;
  document.getElementById('streamContent').innerHTML = rmd(S.streamText);
  sb();
}

function appendThinkText(t) {
  const el = document.getElementById('thinkText');
  if (el) { el.textContent += t; el.scrollTop = el.scrollHeight; }
}

function finishStream(src, model) {
  const st = document.getElementById('streamStatus');
  if (st) st.remove();
  S.lastResp = S.streamText;

  if (src?.length) {
    const sc = document.getElementById('streamMsg');
    if (sc) {
      const ft = document.createElement('div');
      ft.className = 'msg-footer';
      ft.innerHTML = src.slice(0, 6).map(s =>
        `<span class="source-chip">${esc(s.length > 25 ? s.slice(0, 22) + '...' : s)}</span>`
      ).join('') + `<button class="action-btn" onclick="xDocx()">Export .docx</button>`;
      sc.appendChild(ft);
    }
  }
}


/* ═══════════════════════════════════════════════════════
   SEND (SSE)
   ═══════════════════════════════════════════════════════ */
async function send() {
  const inp = document.getElementById('inp');
  const m = inp.value.trim();
  if (!m || S.loading) return;

  S.loading = true;
  S.abortCtrl = new AbortController();
  document.getElementById('sBtn').style.display = 'none';
  document.getElementById('aBtn').style.display = 'flex';
  addMsg('user', m);
  inp.value = '';
  ag(inp);
  startStream();

  try {
    const pay = { session_id: S.ses?.id || null, message: m, mode: S.mode, section_id: S.secId };
    if (S.ovModel) pay.model_override = S.ovModel;
    if (S.ovThink !== '') pay.thinking_override = parseInt(S.ovThink);

    const resp = await fetch('/api/chat/stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(pay),
      signal: S.abortCtrl.signal
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buf = '';
    let model = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream: true });
      const lines = buf.split('\n');
      buf = lines.pop() || '';
      let evtType = '';

      for (const line of lines) {
        if (line.startsWith('event: ')) {
          evtType = line.slice(7);
        } else if (line.startsWith('data: ')) {
          const data = JSON.parse(line.slice(6));

          if (evtType === 'model') {
            model = data.model || '';
            const el = document.getElementById('streamModel');
            if (el) el.textContent = model.replace('claude-', '').replace('-20250929', '');
            if (data.thinking_enabled) {
              document.getElementById('streamStatus').querySelector('span:last-child').textContent = 'Thinking...';
            }
          }
          else if (evtType === 'thinking_start') {
            document.getElementById('thinkBox').classList.add('is-visible');
            document.getElementById('streamStatus').querySelector('span:last-child').textContent = 'Thinking...';
          }
          else if (evtType === 'thinking') { appendThinkText(data.text); }
          else if (evtType === 'thinking_done') {
            document.getElementById('streamStatus').querySelector('span:last-child').textContent = 'Writing...';
          }
          else if (evtType === 'text') { appendStreamText(data.text); }
          else if (evtType === 'done') {
            if (!S.ses && data.session_id) { S.ses = { id: data.session_id }; loadSes(); }
            finishStream(data.sources, model);
            if (data.citations?.length) toast(`${data.citations.length} citations tracked`);
            if (data.cost_usd > 0) {
              document.getElementById('sCost').textContent = '$' + data.cost_usd.toFixed(4);
            }
            if (data.usage?.input_tokens) {
              const u = data.usage;
              const cached = u.cache_read_input_tokens || 0;
              const total_in = u.input_tokens || 0;
              const pct = total_in > 0 ? Math.round(cached / total_in * 100) : 0;
              toast(`$${(data.cost_usd || 0).toFixed(4)} | ${total_in + (u.output_tokens || 0)} tokens${pct > 0 ? ` (${pct}% cached)` : ''}`);
            }
          }
          else if (evtType === 'error') { appendStreamText(`\n\n**Error:** ${data.error}`); }
          evtType = '';
        }
      }
    }
  } catch (e) {
    if (e.name === 'AbortError') {
      appendStreamText('\n\n*[Cancelled]*');
      const st = document.getElementById('streamStatus');
      if (st) st.remove();
    } else {
      appendStreamText(`\n\n**Error:** ${e.message}`);
    }
  } finally {
    S.abortCtrl = null;
    S.loading = false;
    document.getElementById('sBtn').style.display = '';
    document.getElementById('aBtn').style.display = 'none';
    document.getElementById('sBtn').disabled = false;
    document.getElementById('inp').focus();
  }
}

function abortStream() {
  if (S.abortCtrl) S.abortCtrl.abort();
}


/* ═══════════════════════════════════════════════════════
   INPUT HELPERS
   ═══════════════════════════════════════════════════════ */
function hk(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } }
function ag(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 180) + 'px'; }
function qs(mode, text) { setMode(mode); const i = document.getElementById('inp'); i.value = text; ag(i); i.focus(); }
function sb() { const a = document.getElementById('cArea'); requestAnimationFrame(() => a.scrollTop = a.scrollHeight); }


/* ═══════════════════════════════════════════════════════
   DOCUMENTS
   ═══════════════════════════════════════════════════════ */
async function loadDL() {
  try {
    const docs = await api('/api/documents');
    document.getElementById('dFL').innerHTML = docs.map(d =>
      `<div class="doc-file-item" onclick="openD('${esc(d.path)}')" data-p="${esc(d.path)}">
        <span>${esc(d.filename)}</span>
        <span class="file-info">~${d.page_estimate}p</span>
      </div>`
    ).join('') || '<div style="padding:10px;color:var(--text-muted);font-size:12px">No .docx files found</div>';
  } catch (e) {}
}

function togDoc() {
  S.dpOpen = !S.dpOpen;
  document.getElementById('dPan').classList.toggle('is-open', S.dpOpen);
  document.getElementById('dTog').classList.toggle('has-docs', S.dpOpen);
}

async function openD(path) {
  try {
    const d = await api('/api/documents/read', { method: 'POST', body: JSON.stringify({ path }) });
    if (d.error) return toast('Error: ' + d.error);
    S.dPath = path;
    S.dData = d;
    document.getElementById('dTit').textContent = path.split('/').pop();
    document.getElementById('dBd').innerHTML = rmd(d.full_text);
    document.querySelectorAll('.doc-file-item').forEach(el =>
      el.classList.toggle('active', el.dataset.p === path)
    );
    if (!S.dpOpen) togDoc();
    toast(`${d.metadata.word_count.toLocaleString()} words`);

    // Auto-sync structure if paper structure exists
    if (S.structure?.sections?.length) {
      api('/api/structure/auto-sync', {
        method: 'POST',
        body: JSON.stringify({ docx_path: path, generate_summaries: false })
      }).then(r => {
        if (r.ok && r.sections_updated > 0) {
          loadStruct();
          toast(`Auto-synced ${r.sections_updated} sections`);
        }
      }).catch(() => {});
    }
  } catch (e) { toast('Failed'); }
}

function sendForReview() {
  if (!S.dData) return toast('Open a document');
  setMode('review');
  const inp = document.getElementById('inp');
  inp.value = `Review from ${S.dPath.split('/').pop()}:\n\n${S.dData.full_text.substring(0, 6000)}`;
  ag(inp);
  inp.focus();
}

async function syncDoc() {
  if (!S.dPath || !S.secId) return toast('Open doc + select section');
  try {
    const d = await api('/api/structure/sync-docx', {
      method: 'POST', body: JSON.stringify({ section_id: S.secId, docx_path: S.dPath })
    });
    if (d.ok) { toast(`Synced: ${d.word_count} words`); loadStruct(); }
    else toast(d.error);
  } catch (e) { toast('Sync failed'); }
}

async function runAutoSync() {
  if (!S.dPath) return toast('Open a document first');
  toast('Auto-syncing structure...');
  try {
    const d = await api('/api/structure/auto-sync', {
      method: 'POST',
      body: JSON.stringify({ docx_path: S.dPath, generate_summaries: true })
    });
    if (d.error) return toast(d.error);
    toast(`Synced ${d.sections_updated} sections, ${d.summaries_generated} summaries`);
    if (d.unmatched?.length) toast(`Unmatched: ${d.unmatched.join(', ')}`);
    loadStruct();
  } catch (e) { toast('Auto-sync failed'); }
}

async function redThreadAudit() {
  toast('Running Red Thread Audit...');
  try {
    const d = await api('/api/structure/red-thread-audit');
    if (d.error) return toast(d.error);

    // Format audit results as a chat message
    let md = `## Red Thread Audit\n\n`;
    md += `**Core argument:** ${d.red_thread}\n\n`;
    md += `**Overall coherence:** ${d.average_coherence}/5.0 | **Weak transitions:** ${d.weak_transitions}/${d.total_pairs}\n\n`;

    if (d.results?.length) {
      md += `| From | To | Score | Thread | Suggestion |\n|---|---|---|---|---|\n`;
      for (const r of d.results) {
        const icon = r.red_thread === 'visible' ? 'OK' : r.red_thread === 'partial' ? '~' : '!!';
        md += `| ${r.from_section} | ${r.to_section} | ${r.coherence}/5 | ${icon} ${r.red_thread} | ${r.suggestion || '-'} |\n`;
      }
    }

    // Show as agent message
    addMsg('assistant', md, [], true, 'sonnet-4.5');
  } catch (e) { toast('Audit failed'); }
}

async function xDocx() {
  if (!S.lastResp) return toast('No response');
  try {
    const ts = new Date().toISOString().slice(0, 16).replace(/[T:]/g, '_');
    const d = await api('/api/documents/write', {
      method: 'POST', body: JSON.stringify({ content: S.lastResp, filename: `agent_${ts}.docx` })
    });
    if (d.path) {
      window.open(`/api/documents/download/${encodeURIComponent(d.filename)}`, '_blank');
      toast('Exported');
    }
  } catch (e) { toast('Failed'); }
}


/* ═══════════════════════════════════════════════════════
   BIBTEX
   ═══════════════════════════════════════════════════════ */
async function importBib() {
  try {
    let d = await api('/api/citations/import-bibtex', { method: 'POST', body: JSON.stringify({}) });
    if (d.error && d.error.includes('not found')) {
      d = await api('/api/citations/import-zotero', { method: 'POST', body: JSON.stringify({}) });
    }
    if (d.error) return toast(d.error);
    toast(`Imported ${d.imported} references (${d.pdf_matches || 0} matched to PDFs)`);
    loadSt();
  } catch (e) { toast('Import failed — place references.bib or references.json in project root'); }
}


/* ═══════════════════════════════════════════════════════
   UTILITIES
   ═══════════════════════════════════════════════════════ */
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Configure marked.js once
marked.setOptions({ breaks: true, gfm: true, headerIds: false, mangle: false });

function rmd(t) {
  if (!t) return '';
  return marked.parse(t);
}

/* ═══════════════════════════════════════════════════════
   KEYBOARD SHORTCUTS
   ═══════════════════════════════════════════════════════ */
document.addEventListener('keydown', e => {
  const inInput = document.activeElement === document.getElementById('inp');
  const modKey = navigator.platform.includes('Mac') ? e.metaKey : e.ctrlKey;

  // Escape: cancel running stream
  if (e.key === 'Escape' && S.loading) { abortStream(); return; }

  if (modKey && !e.shiftKey && !e.altKey) {
    // Ctrl/Cmd+1-4: mode switching
    const modeMap = {'1': 'chat', '2': 'draft', '3': 'review', '4': 'synthesize'};
    if (modeMap[e.key]) { e.preventDefault(); setMode(modeMap[e.key]); document.getElementById('inp').focus(); return; }
    // Ctrl/Cmd+D: toggle doc panel
    if (e.key === 'd' || e.key === 'D') { e.preventDefault(); togDoc(); return; }
  }

  // / or Ctrl+L: focus input (when not already in input)
  if (!inInput) {
    if (e.key === '/' || (modKey && (e.key === 'l' || e.key === 'L'))) {
      e.preventDefault(); document.getElementById('inp').focus(); return;
    }
  }
});


/* ═══════════════════════════════════════════════════════
   SCAFFOLD MODAL
   ═══════════════════════════════════════════════════════ */
function showScaffold() {
  document.getElementById('scaffoldModal').classList.add('is-visible');
}
function hideScaffold() {
  document.getElementById('scaffoldModal').classList.remove('is-visible');
}
async function createScaffold() {
  const title = document.getElementById('scTitle').value.trim();
  const rq = document.getElementById('scRQ').value.trim();
  const meth = document.getElementById('scMeth').value;
  const lang = document.querySelector('input[name="scLang"]:checked')?.value || 'en';

  try {
    const d = await api('/api/structure/scaffold', {
      method: 'POST',
      body: JSON.stringify({
        title, research_question: rq, methodology: meth, language: lang, overwrite: false
      })
    });
    if (d.error) {
      if (d.exists) {
        if (confirm('paper_structure.yaml already exists. Overwrite?')) {
          const d2 = await api('/api/structure/scaffold', {
            method: 'POST',
            body: JSON.stringify({
              title, research_question: rq, methodology: meth, language: lang, overwrite: true
            })
          });
          if (d2.ok) { toast('Structure created'); hideScaffold(); loadStruct(); return; }
        }
        return;
      }
      return toast(d.error);
    }
    toast('Structure created');
    hideScaffold();
    loadStruct();
  } catch (e) { toast('Failed to create structure'); }
}


/* ═══════════════════════════════════════════════════════
   DOCUMENT TEXT SELECTION MENU
   ═══════════════════════════════════════════════════════ */
let _selText = '';
document.getElementById('dBd').addEventListener('mouseup', e => {
  const sel = window.getSelection();
  const text = sel?.toString().trim();
  const menu = document.getElementById('selMenu');

  if (!text || text.length < 5) {
    menu.classList.remove('is-visible');
    _selText = '';
    return;
  }
  _selText = text;

  // Position at selection
  const range = sel.getRangeAt(0);
  const rect = range.getBoundingClientRect();
  const parent = document.getElementById('dBd').getBoundingClientRect();

  menu.style.left = Math.max(0, (rect.left + rect.right) / 2 - parent.left - 80) + 'px';
  menu.style.top = (rect.top - parent.top - 40 + document.getElementById('dBd').scrollTop) + 'px';
  menu.classList.add('is-visible');
});

document.addEventListener('mousedown', e => {
  const menu = document.getElementById('selMenu');
  if (!menu.contains(e.target)) menu.classList.remove('is-visible');
});

function selAction(mode) {
  if (!_selText) return;
  const menu = document.getElementById('selMenu');
  menu.classList.remove('is-visible');

  setMode(mode);
  const inp = document.getElementById('inp');
  const maxLen = 4000;
  const text = _selText.length > maxLen ? _selText.slice(0, maxLen) + '...' : _selText;

  if (mode === 'review') inp.value = `Review this passage:\n\n${text}`;
  else if (mode === 'draft') inp.value = `Improve this passage. Maintain the academic tone and strengthen the argument:\n\n${text}`;
  else if (mode === 'cite') inp.value = `Find relevant citations for the claims made in this passage:\n\n${text}`;

  ag(inp);
  inp.focus();
  _selText = '';
}


function toast(m) {
  const el = document.getElementById('toast');
  el.textContent = m;
  el.classList.add('is-visible');
  clearTimeout(el._t);
  el._t = setTimeout(() => el.classList.remove('is-visible'), 3000);
}
</script>
</body>
</html>
